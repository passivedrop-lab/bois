"use strict";(()=>{var e={};e.id=2577,e.ids=[2577],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},56310:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>x,patchFetch:()=>w,requestAsyncStorage:()=>g,routeModule:()=>m,serverHooks:()=>h,staticGenerationAsyncStorage:()=>f});var o={};t.r(o),t.d(o,{DELETE:()=>l,GET:()=>p,POST:()=>d});var s=t(49303),a=t(88716),i=t(60670),n=t(87070),u=t(19692);let c=process.env.SUPABASE_PRODUCT_BUCKET||"product-images";async function p(){try{let e=await (0,u.e)(),{data:r,error:t}=await e.from("products").select("*").order("created_at",{ascending:!1});if(t)return n.NextResponse.json({error:"Erreur lecture produits"},{status:500});let o=await Promise.all((r||[]).map(async r=>{if(r.image_path)try{let{data:t,error:o}=await e.storage.from(c).createSignedUrl(r.image_path,3600);!o&&t&&(r.image_url=t.signedUrl)}catch(e){}return r}));return n.NextResponse.json({products:o})}catch(e){return console.error("GET /api/admin/products error:",e),n.NextResponse.json({error:"Erreur serveur"},{status:500})}}async function d(e){try{let r=e.headers.get("content-type")||"",t=await (0,u.e)();if(r.includes("multipart/form-data")){let r=await e.formData(),o=r.get("name"),s=r.get("category"),a=Number(r.get("price"))||0,i=r.get("promoPrice")?Number(r.get("promoPrice")):null,u=r.get("description"),p="true"===r.get("vedette"),d=r.get("image");if(!o)throw Error("Le nom du produit est requis");if(!s)throw Error("La cat\xe9gorie est requise");if(a<=0)throw Error("Le prix doit \xeatre sup\xe9rieur \xe0 0");if(!d)throw Error("L'image est requise");let l=null;if(d&&d.size>0){let e=`${Date.now()}_${d.name.replace(/\s+/g,"_")}`,r=Buffer.from(await d.arrayBuffer());console.log(`[INFO] Uploading image: ${e} to bucket: ${c}`);let{error:o,data:s}=await t.storage.from(c).upload(e,r,{upsert:!1});if(o)throw console.error(`[ERROR] Upload failed for ${e}:`,o),Error(`Erreur upload image: ${o.message}`);l=e,console.log(`[SUCCESS] Image uploaded: ${l}`)}let m={name:o,category:s,price:a,promo_price:i,description:u,image_path:l,vedette:p};console.log("[INFO] Inserting product:",m);let{data:g,error:f}=await t.from("products").insert([m]).select().single();if(f)throw console.error("[ERROR] Insert failed:",f),Error(`Erreur cr\xe9ation produit: ${f.message}`);return console.log("[SUCCESS] Product created:",g),n.NextResponse.json({product:g},{status:201})}let o=await e.json();if(o.id&&(void 0!==o.vedette||o.name||o.category)){let e={};void 0!==o.vedette&&(e.vedette=o.vedette),o.name&&(e.name=o.name),o.category&&(e.category=o.category),void 0!==o.price&&(e.price=o.price),void 0!==o.promo_price&&(e.promo_price=o.promo_price),void 0!==o.description&&(e.description=o.description);let{data:r,error:s}=await t.from("products").update(e).eq("id",o.id).select().single();if(s)return n.NextResponse.json({error:`Erreur mise \xe0 jour: ${s.message}`},{status:500});return n.NextResponse.json({product:r})}let{data:s,error:a}=await t.from("products").insert([o]).select().single();if(a)return n.NextResponse.json({error:`Erreur cr\xe9ation produit: ${a.message}`},{status:500});return n.NextResponse.json({product:s},{status:201})}catch(r){let e=r instanceof Error?r.message:"Erreur inconnue";return console.error("[ERROR] POST /api/admin/products:",e),n.NextResponse.json({error:e},{status:500})}}async function l(e){try{let{searchParams:r}=new URL(e.url),t=r.get("id");if(!t)return n.NextResponse.json({error:"ID requis"},{status:400});let o=await (0,u.e)(),{data:s,error:a}=await o.from("products").select("image_path").eq("id",t).single();a&&console.warn("Produit non trouv\xe9 ou erreur lecture image_path",a);let{error:i}=await o.from("products").delete().eq("id",t);if(i)return n.NextResponse.json({error:"Erreur suppression"},{status:500});if(s&&s.image_path)try{await o.storage.from(c).remove([s.image_path])}catch(e){console.warn("Impossible de supprimer le fichier de storage",e)}return n.NextResponse.json({success:!0})}catch(e){return console.error("DELETE /api/admin/products error:",e),n.NextResponse.json({error:"Erreur serveur"},{status:500})}}let m=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/admin/products/route",pathname:"/api/admin/products",filename:"route",bundlePath:"app/api/admin/products/route"},resolvedPagePath:"/home/deo/Desktop/bois/app/api/admin/products/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:g,staticGenerationAsyncStorage:f,serverHooks:h}=m,x="/api/admin/products/route";function w(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:f})}},19692:(e,r,t)=>{t.d(r,{e:()=>a});var o=t(67721),s=t(71615);async function a(){let e=await (0,s.cookies)();return(0,o.createServerClient)("https://yiygigafhnlwzdsbzdsj.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlpeWdpZ2FmaG5sd3pkc2J6ZHNqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MDYwMjgsImV4cCI6MjA4MzI4MjAyOH0.-f7tLNsGdofpwwtphm0ouRcIj02Ir2RiDzgyvskPs68",{cookies:{getAll:()=>e.getAll(),setAll(r){try{r.forEach(({name:r,value:t,options:o})=>e.set(r,t,o))}catch{}}}})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[9276,5972,7857,9702],()=>t(56310));module.exports=o})();